[default]
include => ai-phone

[ai-phone]
exten => _X.,1,Answer()
same => n,Set(CHANNEL(language)=en)
same => n,NoOp(AI PHONE SERVICE ${EXTEN})

; Trigger Node to process - Send whatever the user dialed
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/start?exten=${EXTEN})

; Wait for Node to process and write the audio files
same => n,Wait(1)

; Get the next file to play from the queue and remove any spaces or newlines
same => n,Set(NEXTFILE=${SHELL(head -n 1 /var/lib/asterisk/sounds/en/queue.txt | tr -d '[:space:]')})

; Log the next file to play
same => n,NoOp(Next file: ${NEXTFILE})

; If the file is empty, hang up
same => n,GotoIf($["${NEXTFILE}"=""]?hangup)

; Play the audio file
same => n,Playback(en/${NEXTFILE})

; Remove the played file from the queue
same => n,System(sed -i '1d' /var/lib/asterisk/sounds/en/queue.txt)

; Log file after sed operation
same => n,System(cat /var/lib/asterisk/sounds/en/queue.txt)

; Wait for the next file (if any)
same => n,Set(NEXTFILECHECK=${SHELL(head -n 1 /var/lib/asterisk/sounds/en/queue.txt | tr -d '[:space:]')})

; Log the file check
same => n,NoOp(Next file check: ${NEXTFILECHECK})

; If the next file is empty, hang up
same => n,GotoIf($["${NEXTFILECHECK}"=""]?hangup)

; Continue the loop if there's more to play, or hang up if empty
same => n,Wait(1)

same => n(hangup),Hangup()
