[default]
include => ai-phone

[ai-phone]

exten => _X!,1,NoOp()
 same => n,Set(CHANNEL(language)=en)
 same => n,Set(CHANNEL(tonezone)=us)
 same => n,NoOp(AI PHONE SERVICE ${EXTEN})

 ; --- START CALL ---
same => n,Ringing()
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/start?exten=${EXTEN}-${UNIQUEID} > /tmp/call_${UNIQUEID}.txt) 

; 1-in-3 chance of forced failure
same => n,Set(FAILCHANCE=${RAND(1,3)})
same => n,GotoIf($[${FAILCHANCE}=1]?failnumber,1)

; --- Read the response into the variable ---
same => n,Set(call_response=${FILE("/tmp/call_${UNIQUEID}.txt")})  ; Capture the response from the file into a variable

same => n,NoOp(Response from Node: ${call_response})  ; Log the response

same => n,GotoIf($["${call_response}"="invalid"]?badnumber,1)

same => n,Set(PICKUP_SOUND=${RAND(1,2)})
same => n,Playback(phone-pick-up-${PICKUP_SOUND})

same => n,NoOp(Answer call...begin playback loop)
same => n,Playback(en/${UNIQUEID}.out)  ; Play initial file
same => n,Answer()
 
same => n,GotoIf($["${call_response}" = "loop"]?loop:hangup)

; --- LOOP CALL ---
same => n(loop),NoOp(Loop call, continuing conversation)
same => n,Record(/var/lib/asterisk/sounds/en/${UNIQUEID}_in.wav,2,8,q)
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/reply?exten=${EXTEN}-${UNIQUEID} > /tmp/reply_${UNIQUEID}.txt) 
same => n,Set(reply_response=${FILE("/tmp/reply_${UNIQUEID}.txt")})
same => n,NoOp(Reply response: ${reply_response})

same => n,Playback(en/${UNIQUEID}.out)
same => n,GotoIf($["${reply_response}" = "exit"]?hangup:loop)

; --- WRONG NUMBER ---
exten => badnumber,1,Set(BAD=${RAND(0,1)})
 same => n,Playback(${IF($[${BAD}=0]?attngt:attntav)})
 same => n,Hangup() 


; --- FAILED CONNECTION ---
exten => failnumber,1,Set(FAIL=${RAND(1,9)})
 same => n,Playback(${IF($[${FAIL}=1]?attearth:${IF($[${FAIL}=2]?atttor:${IF($[${FAIL}=3]?attmud:${IF($[${FAIL}=4]?attsw:${IF($[${FAIL}=5]?atttft:${IF($[${FAIL}=6]?attemerg:${IF($[${FAIL}=7]?attflood:${IF($[${FAIL}=8]?atthur:attlct)})})})})})})})
 same => n,Hangup()


; --- CLEAN EXIT ---
same => n(hangup),NoOp(ending conversation)
;same => n,Playback(switchsounds)
same => n,Set(HANGUP_SOUND=${RAND(1,2)})
same => n,Playback(phone-hang-up-${HANGUP_SOUND})
same => n,Hangup()


;same => n,Playback(phone-receiver-button-1)
;same => n,Playback(phone-pick-up-1)
