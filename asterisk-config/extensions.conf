[default]
include => ai-phone

[ai-phone]
exten => _X.,1,Answer()
 same => n,Set(CHANNEL(language)=en)
 same => n,Set(CHANNEL(tonezone)=us-old)
 same => n,NoOp(AI PHONE SERVICE ${EXTEN})

 ; --- START CALL ---
same => n,Ringing()
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/start?exten=${EXTEN})
same => n,Playback(switchsounds)
same => n,Playback(phone-pick-up-2)

same => n,NoOp(Answer call...begin playback loop)
same => n,Playback(en/${EXTEN}.out)  ; Play initial file
same => n,Answer() 

; --- LOOP START ---
same => n(loop),NoOp(Waiting for user input and recording)
same => n,Record(/var/lib/asterisk/sounds/en/${EXTEN}_in.wav,2,10,q)  ; Record user input
same => n,NoOp(Recording finished with status: ${RECORD_STATUS})

; Call the Node app with the recorded file and wait for response
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/reply?exten=${EXTEN})

same => n,NoOp(Received response, now playing file)
same => n,Playback(en/${EXTEN}.out)  ; Playback the response file generated by Node app (no file extension)

; Continue looping after playback and recording
same => n,Goto(loop)

; --- CLEAN EXIT ---
same => n(hangup),NoOp(Call ended)
same => n,Hangup()
