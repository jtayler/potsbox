[default]
include => ai-phone

[ai-phone]
exten => _X.,1,Answer()
same => n,Set(CHANNEL(language)=en)
same => n,NoOp(AI PHONE SERVICE ${EXTEN})

; Trigger Node to process - Send whatever the user dialed
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/start?exten=${EXTEN})

; Wait for Node to process and write the audio files
same => n,Wait(1)

; Start the loop
same => n(loop),Set(NEXTFILE=${SHELL(head -n 1 /var/lib/asterisk/sounds/en/queue.txt | tr -d '[:space:]')})

; If the file is empty, hang up
same => n,GotoIf($["${NEXTFILE}"=""]?hangup)

; Log the file we are about to play
same => n,NoOp(PLAYING '${NEXTFILE}')

; Play the audio file
same => n,Playback(en/${NEXTFILE})

; Remove the file from the queue (optional, if needed)
same => n,System(sed -i '1d' /var/lib/asterisk/sounds/en/queue.txt)

; Wait a moment before playing the next sound (optional)
same => n,Wait(1)

; Go back to the start of the loop to play the next file
same => n,Goto(loop)

; Hangup after all files are processed
same => n(hangup),Hangup()
