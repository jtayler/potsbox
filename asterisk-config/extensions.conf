[default]
include => ai-phone

[ai-phone]
exten => _X.,1,Answer()
same => n,Set(CHANNEL(language)=en)
same => n,Set(CHANNEL(tonezone)=us-old) 
same => n,NoOp(AI PHONE SERVICE ${EXTEN})

; Trigger Node
same => n,Ringing()    ; Starts playing the USA ring tone to the caller
same => n,System(curl -s -X POST http://host.docker.internal:3000/call/start?exten=${EXTEN})
same => n,Playback(switchsounds)
same => n,Wait(2)
same => n,Answer()     ; Now answer the call and start the AI

; --- START LOOP ---
same => n(loop),Set(NEXTFILE=${SHELL(head -n 1 /var/lib/asterisk/sounds/en/queue.txt | tr -d '[:space:]')})

; FIXED: Point to the label '(hangup)' defined below
same => n,GotoIf($["${NEXTFILE}"=""]?hangup)

same => n,NoOp(PLAYING '${NEXTFILE}')
same => n,Playback(en/${NEXTFILE})
same => n,System(/var/lib/asterisk/sounds/process_queue.sh)
same => n,Wait(1)
same => n,Goto(loop)
; --- END LOOP ---


; FIXED: Added the label '(hangup)' here
same => n(hangup),NoOp(Queue is empty, finishing call)
same => n,Playback(crossbar_connect_sound)
same => n,Wait(1) 
;same => n,Hangup(16)          ; Send "Normal Clearing" signal
